<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Fix8: session.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="fix8_Logo_RGB_small.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Fix8
   &#160;<span id="projectnumber">version  0.5.0</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.8.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('session_8cpp.html','');
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">session.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="session_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//-----------------------------------------------------------------------------------------</span>
<a name="l00002"></a>00002 <span class="preprocessor">#if 0</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span>
<a name="l00004"></a>00004 Fix8 is released under the New BSD License.
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 Copyright (c) 2010-12, David L. Dight &lt;fix@fix8.org&gt;
<a name="l00007"></a>00007 All rights reserved.
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 Redistribution and use in source and binary forms, with or without modification, are
<a name="l00010"></a>00010 permitted provided that the following conditions are met:
<a name="l00011"></a>00011 
<a name="l00012"></a>00012     * Redistributions of source code must retain the above copyright notice, <span class="keyword">this</span> list of
<a name="l00013"></a>00013       conditions and the following disclaimer.
<a name="l00014"></a>00014     * Redistributions in binary form must reproduce the above copyright notice, <span class="keyword">this</span> list
<a name="l00015"></a>00015       of conditions and the following disclaimer in the documentation and/or other
<a name="l00016"></a>00016       materials provided with the distribution.
<a name="l00017"></a>00017     * Neither the name of the author nor the names of its contributors may be used to
<a name="l00018"></a>00018       endorse or promote products derived from <span class="keyword">this</span> software without specific prior
<a name="l00019"></a>00019       written permission.
<a name="l00020"></a>00020     * Products derived from <span class="keyword">this</span> software may not be called <span class="stringliteral">&quot;Fix8&quot;</span>, nor can <span class="stringliteral">&quot;Fix8&quot;</span> appear
<a name="l00021"></a>00021       in their name without written permission from fix8.org
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS <span class="stringliteral">&quot;AS IS&quot;</span> AND ANY EXPRESS
<a name="l00024"></a>00024 OR  IMPLIED  WARRANTIES,  INCLUDING,  BUT  NOT  LIMITED  TO ,  THE  IMPLIED  WARRANTIES  OF
<a name="l00025"></a>00025 MERCHANTABILITY AND  FITNESS FOR A PARTICULAR  PURPOSE ARE  DISCLAIMED. IN  NO EVENT  SHALL
<a name="l00026"></a>00026 THE  COPYRIGHT  OWNER OR  CONTRIBUTORS BE  LIABLE  FOR  ANY DIRECT,  INDIRECT,  INCIDENTAL,
<a name="l00027"></a>00027 SPECIAL,  EXEMPLARY, OR CONSEQUENTIAL  DAMAGES (INCLUDING,  BUT NOT LIMITED TO, PROCUREMENT
<a name="l00028"></a>00028 OF SUBSTITUTE  GOODS OR SERVICES; LOSS OF USE, DATA,  OR PROFITS; OR BUSINESS INTERRUPTION)
<a name="l00029"></a>00029 HOWEVER CAUSED  AND ON ANY THEORY OF LIABILITY, WHETHER  IN CONTRACT, STRICT  LIABILITY, OR
<a name="l00030"></a>00030 TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE
<a name="l00031"></a>00031 EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 #endif
<a name="l00034"></a>00034 <span class="comment">//-----------------------------------------------------------------------------------------</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;fstream&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;set&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;iterator&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;memory&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;iomanip&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;numeric&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;bitset&gt;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;strings.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;regex.h&gt;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;<a class="code" href="f8includes_8hpp.html">f8includes.hpp</a>&gt;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00054"></a>00054 <span class="keyword">using namespace </span>FIX8;
<a name="l00055"></a>00055 <span class="keyword">using namespace </span>std;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00058"></a>00058 <a class="code" href="classFIX8_1_1RegExp.html" title="POSIX regex wrapper class.">RegExp</a> <a class="code" href="classFIX8_1_1SessionID.html#ade959f8854e847703f42318fece88f63">SessionID::_sid</a>(<span class="stringliteral">&quot;([^:]+):([^-]+)-&gt;(.+)&quot;</span>);
<a name="l00059"></a>00059 <a class="code" href="classFIX8_1_1RegExp.html" title="POSIX regex wrapper class.">RegExp</a> <a class="code" href="classFIX8_1_1Session.html#aabfb501796d918107c99bdbb48ff1219">Session::_seq</a>(<span class="stringliteral">&quot;34=([^\x01]+)\x01&quot;</span>);
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00062"></a>00062 <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Tickval.html#ae868236e7da40dc66da30ae7d00784fa">Tickval::ticks</a> <a class="code" href="classFIX8_1_1Tickval.html#a7a56f1507706ad9692d246a05aef2cb8">Tickval::noticks</a>;
<a name="l00063"></a>00063 <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Tickval.html#ae868236e7da40dc66da30ae7d00784fa">Tickval::ticks</a> <a class="code" href="classFIX8_1_1Tickval.html#ac1dc112410dfe3cfa507515fe4b0de2a">Tickval::thousand</a>;
<a name="l00064"></a>00064 <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Tickval.html#ae868236e7da40dc66da30ae7d00784fa">Tickval::ticks</a> <a class="code" href="classFIX8_1_1Tickval.html#ac7b662d53b282e7a1efce137a1c82152">Tickval::million</a>;
<a name="l00065"></a>00065 <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Tickval.html#ae868236e7da40dc66da30ae7d00784fa">Tickval::ticks</a> <a class="code" href="classFIX8_1_1Tickval.html#a07b93acdf1d4c89b04549af53a58abc5">Tickval::billion</a>;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00068"></a>00068 <span class="keyword">template</span>&lt;&gt;
<a name="l00069"></a>00069 <span class="keyword">const</span> <a class="code" href="structFIX8_1_1StaticTable.html#ac86564eefb2ebdfb77ca8572fd26fb34">Session::Handlers::TypePair</a> <a class="code" href="structFIX8_1_1StaticTable.html#ab1c72d3c402d884a7d64881334f62d6e" title="The actual data set.">Session::Handlers::_valueTable</a>[] =
<a name="l00070"></a>00070 {
<a name="l00071"></a>00071    <a class="code" href="structFIX8_1_1StaticTable.html#ac86564eefb2ebdfb77ca8572fd26fb34">Session::Handlers::TypePair</a>(<a class="code" href="namespaceFIX8.html#aa30604797b7d0eb424f057eea0d40120">Common_MsgType_HEARTBEAT</a>, &amp;<a class="code" href="classFIX8_1_1Session.html#ae5bf54b50e2ef6ef06532e7bbe535604">Session::handle_heartbeat</a>),
<a name="l00072"></a>00072    <a class="code" href="structFIX8_1_1StaticTable.html#ac86564eefb2ebdfb77ca8572fd26fb34">Session::Handlers::TypePair</a>(<a class="code" href="namespaceFIX8.html#ab81da725128a9689b97c5db7fa6c1a0e">Common_MsgType_TEST_REQUEST</a>, &amp;<a class="code" href="classFIX8_1_1Session.html#ae26764de9f1b7da26f1659de8b146aeb">Session::handle_test_request</a>),
<a name="l00073"></a>00073    <a class="code" href="structFIX8_1_1StaticTable.html#ac86564eefb2ebdfb77ca8572fd26fb34">Session::Handlers::TypePair</a>(<a class="code" href="namespaceFIX8.html#a335f1df36e788ddcb1019dbc7c3fd0ce">Common_MsgType_RESEND_REQUEST</a>, &amp;<a class="code" href="classFIX8_1_1Session.html#a3225a1c0290539638f2051a6c63b39a5">Session::handle_resend_request</a>),
<a name="l00074"></a>00074    <a class="code" href="structFIX8_1_1StaticTable.html#ac86564eefb2ebdfb77ca8572fd26fb34">Session::Handlers::TypePair</a>(<a class="code" href="namespaceFIX8.html#ac50be7cf0a144e9b4caff37eae3b3d53">Common_MsgType_REJECT</a>, &amp;<a class="code" href="classFIX8_1_1Session.html#ae07d7722b70256b6fa83739e2ec4f77e">Session::handle_reject</a>),
<a name="l00075"></a>00075    <a class="code" href="structFIX8_1_1StaticTable.html#ac86564eefb2ebdfb77ca8572fd26fb34">Session::Handlers::TypePair</a>(<a class="code" href="namespaceFIX8.html#a77cd307386bbd382d44d0872ee70a7b5">Common_MsgType_SEQUENCE_RESET</a>, &amp;<a class="code" href="classFIX8_1_1Session.html#aa9c2ec078b93b45b4b8a591ea676881b">Session::handle_sequence_reset</a>),
<a name="l00076"></a>00076    <a class="code" href="structFIX8_1_1StaticTable.html#ac86564eefb2ebdfb77ca8572fd26fb34">Session::Handlers::TypePair</a>(<a class="code" href="namespaceFIX8.html#a7b0993ad8aff8a082fff252e62222475">Common_MsgType_LOGOUT</a>, &amp;<a class="code" href="classFIX8_1_1Session.html#a29bd6e9852f4af85a6ecd22ef4ae2dcb">Session::handle_logout</a>),
<a name="l00077"></a>00077    <a class="code" href="structFIX8_1_1StaticTable.html#ac86564eefb2ebdfb77ca8572fd26fb34">Session::Handlers::TypePair</a>(<a class="code" href="namespaceFIX8.html#a35904f2126893066927ae534f6bc95ed">Common_MsgType_LOGON</a>, &amp;<a class="code" href="classFIX8_1_1Session.html#a5dc4147c372c8f3a05f2bc29b1d8c1c5">Session::handle_logon</a>),
<a name="l00078"></a>00078 };
<a name="l00079"></a>00079 <span class="keyword">template</span>&lt;&gt;
<a name="l00080"></a><a class="code" href="classFIX8_1_1Session.html#a5821c2539f58e91fc4b2724a1d04eb5f">00080</a> <span class="keyword">const</span> <a class="code" href="structFIX8_1_1StaticTable.html#a267de06cd639bc971f139143308713cb">Session::Handlers::NotFoundType</a> <a class="code" href="structFIX8_1_1StaticTable.html#a99ddd3f4948cef595c6b1b68048760b9" title="The value to return when the key is not found.">Session::Handlers::_noval</a>(&amp;<a class="code" href="classFIX8_1_1Session.html#a5821c2539f58e91fc4b2724a1d04eb5f">Session::handle_application</a>);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="keyword">template</span>&lt;&gt;
<a name="l00083"></a>00083 <span class="keyword">const</span> <a class="code" href="structFIX8_1_1StaticTable.html#a2ad0208949fe9e985ca78d0ae3edff05">Session::Handlers::TypeMap</a> <a class="code" href="structFIX8_1_1StaticTable.html#a5988f8af31730212ab748c79b6381df0" title="The container.">Session::Handlers::_valuemap</a>(<a class="code" href="structFIX8_1_1StaticTable.html#ab1c72d3c402d884a7d64881334f62d6e" title="The actual data set.">Session::Handlers::_valueTable</a>,
<a name="l00084"></a>00084    <a class="code" href="structFIX8_1_1StaticTable.html#a01f50857699799ca7537a1a550ae67a5">Session::Handlers::get_table_end</a>());
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00087"></a><a class="code" href="classFIX8_1_1SessionID.html#a0ce1f3ba3cf5355bff480325f4acce0a">00087</a> <span class="keywordtype">void</span> <a class="code" href="classFIX8_1_1SessionID.html#a0ce1f3ba3cf5355bff480325f4acce0a">SessionID::make_id</a>()
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089    <a class="code" href="namespaceFIX8.html#a5460478d112c38b40aaeece24739d761">f8ostrstream</a> ostr;
<a name="l00090"></a>00090    ostr &lt;&lt; _beginString &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; _targetCompID &lt;&lt; <span class="stringliteral">&quot;-&gt;&quot;</span> &lt;&lt; _senderCompID;
<a name="l00091"></a>00091    _rid = ostr.str();
<a name="l00092"></a>00092    ostr.str(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00093"></a>00093    ostr &lt;&lt; _beginString &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; _senderCompID &lt;&lt; <span class="stringliteral">&quot;-&gt;&quot;</span> &lt;&lt; _targetCompID;
<a name="l00094"></a>00094    _id = ostr.str();
<a name="l00095"></a>00095 }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00098"></a><a class="code" href="classFIX8_1_1SessionID.html#a9d6dd03dd2c4a2d8f9b44a23b126fe15">00098</a> <span class="keywordtype">void</span> <a class="code" href="classFIX8_1_1SessionID.html#a9d6dd03dd2c4a2d8f9b44a23b126fe15" title="Create a sessionid string.">SessionID::from_string</a>(<span class="keyword">const</span> <a class="code" href="namespaceFIX8.html#a653abc4baa49d96ad764ffc8f3dce148">f8String</a>&amp; from)
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100    <a class="code" href="classFIX8_1_1RegMatch.html" title="A class to contain regex matches using RegExp.">RegMatch</a> match;
<a name="l00101"></a>00101    <span class="keywordflow">if</span> (_sid.SearchString(match, from, 4) == 4)
<a name="l00102"></a>00102    {
<a name="l00103"></a>00103       <a class="code" href="namespaceFIX8.html#a653abc4baa49d96ad764ffc8f3dce148">f8String</a> bstr, scid, tcid;
<a name="l00104"></a>00104       _sid.SubExpr(match, from, bstr, 0, 1);
<a name="l00105"></a>00105       _beginString.set(bstr);
<a name="l00106"></a>00106       _sid.SubExpr(match, from, scid, 0, 2);
<a name="l00107"></a>00107       _senderCompID.set(scid);
<a name="l00108"></a>00108       _sid.SubExpr(match, from, tcid, 0, 3);
<a name="l00109"></a>00109       _targetCompID.set(tcid);
<a name="l00110"></a>00110       make_id();
<a name="l00111"></a>00111    }
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00115"></a>00115 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00116"></a><a class="code" href="classFIX8_1_1Session.html#a8444adfe07c5dd62c2eeb0de46daff07">00116</a> <a class="code" href="classFIX8_1_1Session.html#a8444adfe07c5dd62c2eeb0de46daff07">Session::Session</a>(<span class="keyword">const</span> <a class="code" href="structFIX8_1_1F8MetaCntx.html" title="Static metadata context class - one per FIX xml schema.">F8MetaCntx</a>&amp; <a class="code" href="namespaceFIX8_1_1TEX.html#a51c71fd32dd93234cd45486cac2ee12f">ctx</a>, <span class="keyword">const</span> <a class="code" href="classFIX8_1_1SessionID.html" title="Quickfix style sessionid.">SessionID</a>&amp; sid, <a class="code" href="classFIX8_1_1Persister.html" title="Base (ABC) Persister class.">Persister</a> *persist, <a class="code" href="classFIX8_1_1Logger.html" title="Thread delegated async logging class.">Logger</a> *logger, <a class="code" href="classFIX8_1_1Logger.html" title="Thread delegated async logging class.">Logger</a> *plogger) :
<a name="l00117"></a>00117    _last_sent(), _last_received(),
<a name="l00118"></a>00118    _ctx(ctx), _connection(), _req_next_send_seq(), _req_next_receive_seq(),
<a name="l00119"></a>00119    _sid(sid), _login_retry_interval(default_retry_interval), _login_retries(default_login_retries),
<a name="l00120"></a>00120    _reset_sequence_numbers(), _persist(persist), _logger(logger), _plogger(plogger),   <span class="comment">// initiator</span>
<a name="l00121"></a>00121    _timer(*this, 10), _hb_processor(&amp;<a class="code" href="classFIX8_1_1Session.html" title="Fix8 Base Session. User sessions derive from this class.">Session</a>::heartbeat_service)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123    <a class="code" href="classFIX8_1_1Session.html#a913639843c4d5fec356c564d69235717">_timer</a>.<a class="code" href="classFIX8_1_1Timer.html#aa57170841069bcafd9aed79595e3d962" title="Start the timer thread.">start</a>();
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00127"></a><a class="code" href="classFIX8_1_1Session.html#a0f96fb2ddd808c9dedc1cf3bd7bbc349">00127</a> <a class="code" href="classFIX8_1_1Session.html#a8444adfe07c5dd62c2eeb0de46daff07">Session::Session</a>(<span class="keyword">const</span> <a class="code" href="structFIX8_1_1F8MetaCntx.html" title="Static metadata context class - one per FIX xml schema.">F8MetaCntx</a>&amp; <a class="code" href="namespaceFIX8_1_1TEX.html#a51c71fd32dd93234cd45486cac2ee12f">ctx</a>, <a class="code" href="classFIX8_1_1Persister.html" title="Base (ABC) Persister class.">Persister</a> *persist, <a class="code" href="classFIX8_1_1Logger.html" title="Thread delegated async logging class.">Logger</a> *logger, <a class="code" href="classFIX8_1_1Logger.html" title="Thread delegated async logging class.">Logger</a> *plogger) :
<a name="l00128"></a>00128    _last_sent(), _last_received(),
<a name="l00129"></a>00129    _ctx(ctx), _connection(), _req_next_send_seq(), _req_next_receive_seq(),
<a name="l00130"></a>00130    _login_retry_interval(default_retry_interval), _login_retries(default_login_retries),
<a name="l00131"></a>00131    _reset_sequence_numbers(), _persist(persist), _logger(logger), _plogger(plogger),   <span class="comment">// acceptor</span>
<a name="l00132"></a>00132    _timer(*this, 10), _hb_processor(&amp;<a class="code" href="classFIX8_1_1Session.html" title="Fix8 Base Session. User sessions derive from this class.">Session</a>::heartbeat_service)
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134    <a class="code" href="classFIX8_1_1Session.html#a913639843c4d5fec356c564d69235717">_timer</a>.<a class="code" href="classFIX8_1_1Timer.html#aa57170841069bcafd9aed79595e3d962" title="Start the timer thread.">start</a>();
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00138"></a><a class="code" href="classFIX8_1_1Session.html#a1a24b94951806e1273f8586ea2e83279">00138</a> <span class="keywordtype">void</span> <a class="code" href="classFIX8_1_1Session.html#a1a24b94951806e1273f8586ea2e83279">Session::atomic_init</a>(<a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8">States::SessionStates</a> st)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140    <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = st;
<a name="l00141"></a>00141    <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a> = <a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a> = 1;
<a name="l00142"></a>00142    <a class="code" href="classFIX8_1_1Session.html#a8bb5b91c87ef07a96abe77464e3cb1cc">_last_sent</a> = <span class="keyword">new</span> <a class="code" href="classFIX8_1_1Tickval.html" title="High resolution time in nanosecond ticks.">Tickval</a>(<span class="keyword">true</span>);
<a name="l00143"></a>00143    <a class="code" href="classFIX8_1_1Session.html#a39d0ae002b22f23d3a644bf4dcbb15b2">_last_received</a> = <span class="keyword">new</span> <a class="code" href="classFIX8_1_1Tickval.html" title="High resolution time in nanosecond ticks.">Tickval</a>(<span class="keyword">true</span>);
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00147"></a><a class="code" href="classFIX8_1_1Session.html#a8753bb9dee966b7d39abc9b7237cd665">00147</a> <a class="code" href="classFIX8_1_1Session.html#a8753bb9dee966b7d39abc9b7237cd665" title="Dtor.">Session::~Session</a>()
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#a005ce624dc6ec4042f7a114d231663c5">_logger</a>)
<a name="l00150"></a>00150    {
<a name="l00151"></a>00151       <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(<span class="stringliteral">&quot;Session terminating&quot;</span>);
<a name="l00152"></a>00152       <a class="code" href="classFIX8_1_1Session.html#a005ce624dc6ec4042f7a114d231663c5">_logger</a>-&gt;<a class="code" href="classFIX8_1_1Logger.html#a858c1ea1f37e54d330c5ab05b4fb80a3" title="Stop the logging thread.">stop</a>();
<a name="l00153"></a>00153    }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155    <span class="keyword">delete</span> <a class="code" href="classFIX8_1_1Session.html#a8bb5b91c87ef07a96abe77464e3cb1cc">_last_sent</a>;
<a name="l00156"></a>00156    <span class="keyword">delete</span> <a class="code" href="classFIX8_1_1Session.html#a39d0ae002b22f23d3a644bf4dcbb15b2">_last_received</a>;
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00160"></a><a class="code" href="classFIX8_1_1Session.html#afaa979ddebd207aa19bf8f71f5f50e63">00160</a> <span class="keywordtype">int</span> <a class="code" href="classFIX8_1_1Session.html#afaa979ddebd207aa19bf8f71f5f50e63">Session::start</a>(<a class="code" href="classFIX8_1_1Connection.html" title="Complete Fix connection (reader and writer).">Connection</a> *connection, <span class="keywordtype">bool</span> wait, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> send_seqnum,
<a name="l00161"></a>00161    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> recv_seqnum, <span class="keyword">const</span> <a class="code" href="namespaceFIX8.html#a653abc4baa49d96ad764ffc8f3dce148">f8String</a> davi)
<a name="l00162"></a>00162 {
<a name="l00163"></a>00163    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#a005ce624dc6ec4042f7a114d231663c5">_logger</a>)
<a name="l00164"></a>00164       <a class="code" href="classFIX8_1_1Session.html#a005ce624dc6ec4042f7a114d231663c5">_logger</a>-&gt;<a class="code" href="classFIX8_1_1Logger.html#a8175e14a66ef836973ac504cf04170ef" title="Remove dead threads from the thread code cache.">purge_thread_codes</a>();
<a name="l00165"></a>00165    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#a69391e7124d24a35f0c7b33addcf0826">_plogger</a>)
<a name="l00166"></a>00166       <a class="code" href="classFIX8_1_1Session.html#a69391e7124d24a35f0c7b33addcf0826">_plogger</a>-&gt;<a class="code" href="classFIX8_1_1Logger.html#a8175e14a66ef836973ac504cf04170ef" title="Remove dead threads from the thread code cache.">purge_thread_codes</a>();
<a name="l00167"></a>00167    <a class="code" href="classFIX8_1_1Session.html#ae96b4953282a1bbb4e5f715fe02b0514">_control</a>.<a class="code" href="classFIX8_1_1ebitset__r.html#a5701de060a6c254cc9e92ae10e34ea0f">clear</a>(<a class="code" href="classFIX8_1_1Session.html#a3196cc395f678f1f52fd6498cdea2caaa5016fc4b321b44eaa80c39a3736d980e">shutdown</a>);
<a name="l00168"></a>00168    <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(<span class="stringliteral">&quot;Starting session&quot;</span>);
<a name="l00169"></a>00169    <a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a> = connection; <span class="comment">// takes owership</span>
<a name="l00170"></a>00170    <span class="keywordflow">if</span> (!<a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#a506c527366cc53efdeeeaf5012573398">connect</a>()) <span class="comment">// if already connected returns true</span>
<a name="l00171"></a>00171       <span class="keywordflow">return</span> -1;;
<a name="l00172"></a>00172    <a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#a47c25a31352a71e2a6902d37fc5fa2ba" title="Start the reader and writer threads.">start</a>();
<a name="l00173"></a>00173    <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(<span class="stringliteral">&quot;Session connected&quot;</span>);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#a5e55875fe93bcfcae541ddbcb250ac0b">get_role</a>() == <a class="code" href="classFIX8_1_1Connection.html#ac7c5a73f9b3727fce73c3240bb57e804a70ed88dfc473fbf4b1c8b48a8d8df290">Connection::cn_initiator</a>)
<a name="l00176"></a>00176    {
<a name="l00177"></a>00177       <a class="code" href="classFIX8_1_1Session.html#a1a24b94951806e1273f8586ea2e83279">atomic_init</a>(<a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a02d9e5186208804327300c4fd6b0ba83">States::st_not_logged_in</a>);
<a name="l00178"></a>00178       <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#ac4617326be134747e0682dfe6a70a932">_reset_sequence_numbers</a>)
<a name="l00179"></a>00179          <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a> = <a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a> = 1;
<a name="l00180"></a>00180       <span class="keywordflow">else</span>
<a name="l00181"></a>00181       {
<a name="l00182"></a>00182          <a class="code" href="classFIX8_1_1Session.html#a6b44f0258866134e9da79723c50dafa4" title="Recover next expected and next to send sequence numbers from persitence layer.">recover_seqnums</a>();
<a name="l00183"></a>00183          <span class="keywordflow">if</span> (send_seqnum)
<a name="l00184"></a>00184             <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a> = send_seqnum;
<a name="l00185"></a>00185          <span class="keywordflow">if</span> (recv_seqnum)
<a name="l00186"></a>00186             <a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a> = recv_seqnum;
<a name="l00187"></a>00187       }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189       <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Session.html#af6a1b902be5e2e2d282317bfc7c76110">generate_logon</a>(<a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#a4ef6dd0e741a007bf9261cb44f8e5de1">get_hb_interval</a>(), davi));
<a name="l00190"></a>00190       <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(msg);
<a name="l00191"></a>00191       <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8ab0c0b5e0904bbbaf07262d3b3de1dc6b">States::st_logon_sent</a>;
<a name="l00192"></a>00192    }
<a name="l00193"></a>00193    <span class="keywordflow">else</span>
<a name="l00194"></a>00194    {
<a name="l00195"></a>00195       <a class="code" href="classFIX8_1_1Session.html#a1a24b94951806e1273f8586ea2e83279">atomic_init</a>(<a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8adf53f4db113eb986945b0f5eebcca2ec">States::st_wait_for_logon</a>);
<a name="l00196"></a>00196       <span class="keywordflow">if</span> (send_seqnum)
<a name="l00197"></a>00197          <a class="code" href="classFIX8_1_1Session.html#a24fd154f8f9d60dc5326c7be6be17aa7">_req_next_send_seq</a> = send_seqnum;
<a name="l00198"></a>00198       <span class="keywordflow">if</span> (recv_seqnum)
<a name="l00199"></a>00199          <a class="code" href="classFIX8_1_1Session.html#a91cdc6cbdb2d43cce4d16d73706be6e9">_req_next_receive_seq</a> = recv_seqnum;
<a name="l00200"></a>00200    }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202    <span class="keywordflow">if</span> (wait)   <span class="comment">// wait for</span>
<a name="l00203"></a>00203    {
<a name="l00204"></a>00204       <a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#ae626e72310afa1b0ef4ca9b4e6c3630b">join</a>();
<a name="l00205"></a>00205    }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207    <span class="keywordflow">return</span> 0;
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00211"></a><a class="code" href="classFIX8_1_1Session.html#ae4c637cd36d88ddac5a1db2565f82ef1">00211</a> <span class="keywordtype">void</span> <a class="code" href="classFIX8_1_1Session.html#ae4c637cd36d88ddac5a1db2565f82ef1" title="stop the session.">Session::stop</a>()
<a name="l00212"></a>00212 {
<a name="l00213"></a>00213    <a class="code" href="classFIX8_1_1Session.html#ae96b4953282a1bbb4e5f715fe02b0514">_control</a> |= <a class="code" href="classFIX8_1_1Session.html#a3196cc395f678f1f52fd6498cdea2caaa5016fc4b321b44eaa80c39a3736d980e">shutdown</a>;
<a name="l00214"></a>00214    <a class="code" href="classFIX8_1_1Session.html#a913639843c4d5fec356c564d69235717">_timer</a>.<a class="code" href="classFIX8_1_1Timer.html#a67273582c31d26851df37b284d1256cc">schedule</a>(<a class="code" href="classFIX8_1_1Session.html#a0c38e60ca2bbdb96733f6ba831ca2ab5">_hb_processor</a>, 0);
<a name="l00215"></a>00215    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acb236bba1eca3b8c6a636b74425aa574">_persist</a>)
<a name="l00216"></a>00216       <a class="code" href="classFIX8_1_1Session.html#acb236bba1eca3b8c6a636b74425aa574">_persist</a>-&gt;<a class="code" href="classFIX8_1_1Persister.html#a7cd911c314b215c6dba3433fbed45a71" title="Stop the persister thread.">stop</a>();
<a name="l00217"></a>00217    <a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#a9a584ddd21bf93a9d721c0be9f87ab59" title="Stop the reader and writer threads.">stop</a>();
<a name="l00218"></a>00218    <a class="code" href="namespaceFIX8.html#a0b4507afd061f00de270d755d3b1e5a7">millisleep</a>(250); <span class="comment">// let the thread shutdowns finish</span>
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00222"></a><a class="code" href="classFIX8_1_1Session.html#a755535b6a25422b7e13d32368113f5b4">00222</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#a755535b6a25422b7e13d32368113f5b4">Session::enforce</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> seqnum, <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg)
<a name="l00223"></a>00223 {
<a name="l00224"></a>00224    <span class="keywordflow">if</span> (<a class="code" href="structFIX8_1_1States.html#a1739254b6600e1982fbdf7b49baf8b79">States::is_established</a>(<a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a>))
<a name="l00225"></a>00225    {
<a name="l00226"></a>00226       <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> != <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a436b187afe7fbb64faf7bc72297f60ce">States::st_logon_received</a>)
<a name="l00227"></a>00227          <a class="code" href="classFIX8_1_1Session.html#abda2e814594f4238b9a6ee303f7fae93">compid_check</a>(seqnum, msg);
<a name="l00228"></a>00228       <a class="code" href="structFIX8_1_1Field.html" title="ABC field template. Partial specialisations of this class use Int2Type idiom.">gap_fill_flag</a> gff;
<a name="l00229"></a>00229       <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#afdb890848e89e7f3b0b941f20c02a1f1">get_msgtype</a>() != <a class="code" href="namespaceFIX8.html#a77cd307386bbd382d44d0872ee70a7b5">Common_MsgType_SEQUENCE_RESET</a> &amp;&amp; <a class="code" href="classFIX8_1_1Session.html#a633b4c067941d09112acaa7efc452272">sequence_check</a>(seqnum, msg))
<a name="l00230"></a>00230          <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00231"></a>00231    }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00237"></a><a class="code" href="classFIX8_1_1Session.html#aedc5524499f1ee5767b642792c9c010e">00237</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#aedc5524499f1ee5767b642792c9c010e">Session::process</a>(<span class="keyword">const</span> <a class="code" href="namespaceFIX8.html#a653abc4baa49d96ad764ffc8f3dce148">f8String</a>&amp; from)
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239    <span class="keywordtype">unsigned</span> seqnum(0);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241    <span class="keywordflow">try</span>
<a name="l00242"></a>00242    {
<a name="l00243"></a>00243       <a class="code" href="classFIX8_1_1RegMatch.html" title="A class to contain regex matches using RegExp.">RegMatch</a> match;
<a name="l00244"></a>00244       <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#aabfb501796d918107c99bdbb48ff1219">_seq</a>.<a class="code" href="classFIX8_1_1RegExp.html#a6dcc79a6a9a658e78982026ce96e8ae6">SearchString</a>(match, from, 2, 0) != 2)
<a name="l00245"></a>00245          <span class="keywordflow">throw</span> <a class="code" href="structFIX8_1_1InvalidMessage.html" title="An invalid message was requested or decoded.">InvalidMessage</a>(from);
<a name="l00246"></a>00246       <a class="code" href="namespaceFIX8.html#a653abc4baa49d96ad764ffc8f3dce148">f8String</a> seqstr;
<a name="l00247"></a>00247       <a class="code" href="classFIX8_1_1Session.html#aabfb501796d918107c99bdbb48ff1219">_seq</a>.<a class="code" href="classFIX8_1_1RegExp.html#a98ceca9e7a00eee1fe34ab3829946891">SubExpr</a>(match, from, seqstr, 0, 1);
<a name="l00248"></a>00248       seqnum = GetValue&lt;unsigned&gt;(seqstr);
<a name="l00249"></a>00249 
<a name="l00250"></a>00250       <a class="code" href="classFIX8_1_1Session.html#a8fc99dac42d6cd940954dc575671c522">plog</a>(from, 1);
<a name="l00251"></a>00251       <a class="code" href="classFIX8_1_1scoped__ptr.html" title="C++11 inspired scoped pointer.">scoped_ptr&lt;Message&gt;</a> msg(<a class="code" href="classFIX8_1_1Message.html#a825a6117953bc9ea2f3ac99a00c81037">Message::factory</a>(<a class="code" href="classFIX8_1_1Session.html#af9ff171d40c5f8747c2045bf7afb3041">_ctx</a>, from));
<a name="l00252"></a>00252       <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#ae96b4953282a1bbb4e5f715fe02b0514">_control</a> &amp; <a class="code" href="classFIX8_1_1Session.html#a3196cc395f678f1f52fd6498cdea2caaaa43fb4836277e668cd544a67c08cace7">print</a>)
<a name="l00253"></a>00253          cout &lt;&lt; *msg &lt;&lt; endl;
<a name="l00254"></a>00254       <span class="keywordtype">bool</span> result((msg-&gt;<a class="code" href="classFIX8_1_1Message.html#a0d94fdcac5c21ee76b99417db9a85c3b">is_admin</a>() ? <a class="code" href="classFIX8_1_1Session.html#ad5a50d4f7dd946ffa8c55165d56b99e0">handle_admin</a>(seqnum, msg.<a class="code" href="classFIX8_1_1scoped__ptr.html#ad398c370f7b8bbb51110e3e1d2c39a67">get</a>()) : <span class="keyword">true</span>)
<a name="l00255"></a>00255          &amp;&amp; (this-&gt;*<a class="code" href="classFIX8_1_1Session.html#a965be60f1abf9e3f7674fc3d84910eda">_handlers</a>.<a class="code" href="structFIX8_1_1StaticTable.html#a7e039205676d71c27d3d8c39059b5b21">find_ref</a>(msg-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#afdb890848e89e7f3b0b941f20c02a1f1">get_msgtype</a>()))(seqnum, msg.<a class="code" href="classFIX8_1_1scoped__ptr.html#ad398c370f7b8bbb51110e3e1d2c39a67">get</a>()));
<a name="l00256"></a>00256       ++<a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a>;
<a name="l00257"></a>00257       <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acb236bba1eca3b8c6a636b74425aa574">_persist</a>)
<a name="l00258"></a>00258       {
<a name="l00259"></a>00259          <a class="code" href="classFIX8_1_1Session.html#acb236bba1eca3b8c6a636b74425aa574">_persist</a>-&gt;<a class="code" href="classFIX8_1_1Persister.html#a2318928465e09f9c0b8973258e8f3add">put</a>(<a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a>, <a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a>);
<a name="l00260"></a>00260          <span class="comment">//cout &lt;&lt; &quot;Persisted:&quot; &lt;&lt; _next_send_seq &lt;&lt; &quot; and &quot; &lt;&lt; _next_receive_seq &lt;&lt; endl;</span>
<a name="l00261"></a>00261       }
<a name="l00262"></a>00262       <span class="keywordflow">return</span> result;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264    }
<a name="l00265"></a>00265    <span class="keywordflow">catch</span> (<a class="code" href="classFIX8_1_1f8Exception.html" title="Base exception class.">f8Exception</a>&amp; e)
<a name="l00266"></a>00266    {
<a name="l00267"></a>00267       <span class="comment">//cout &lt;&lt; &quot;process:: f8exception&quot; &lt;&lt; &#39; &#39; &lt;&lt; seqnum &lt;&lt; &#39; &#39; &lt;&lt; e.what() &lt;&lt; endl;</span>
<a name="l00268"></a>00268 
<a name="l00269"></a>00269       <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(e.<a class="code" href="classFIX8_1_1f8Exception.html#abb6a7867b11df20e941a87b1c8447bb1">what</a>());
<a name="l00270"></a>00270       <span class="keywordflow">if</span> (!e.<a class="code" href="classFIX8_1_1f8Exception.html#a2b4ab08104073be15cb3af79328753e5">force_logoff</a>())
<a name="l00271"></a>00271       {
<a name="l00272"></a>00272          <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Session.html#a2c1493ab549b191101c95bb8bb6d0afa">generate_reject</a>(seqnum, e.<a class="code" href="classFIX8_1_1f8Exception.html#abb6a7867b11df20e941a87b1c8447bb1">what</a>()));
<a name="l00273"></a>00273          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(msg);
<a name="l00274"></a>00274       }
<a name="l00275"></a>00275       <span class="keywordflow">else</span>
<a name="l00276"></a>00276       {
<a name="l00277"></a>00277          <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> != <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a436b187afe7fbb64faf7bc72297f60ce">States::st_logon_received</a>)
<a name="l00278"></a>00278          {
<a name="l00279"></a>00279             <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(<a class="code" href="classFIX8_1_1Session.html#abc1e0fa8b9619aa66d6c59b21e25da78">generate_logout</a>(), 0, <span class="keyword">true</span>); <span class="comment">// so it won&#39;t increment</span>
<a name="l00280"></a>00280             <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a385060f5590bc613b4df74d8b3bced56">States::st_logoff_sent</a>;
<a name="l00281"></a>00281          }
<a name="l00282"></a>00282          <a class="code" href="classFIX8_1_1Session.html#ae4c637cd36d88ddac5a1db2565f82ef1" title="stop the session.">stop</a>();
<a name="l00283"></a>00283       }
<a name="l00284"></a>00284    }
<a name="l00285"></a>00285    <span class="keywordflow">catch</span> (exception&amp; e) <span class="comment">// also catches Poco::Net::NetException</span>
<a name="l00286"></a>00286    {
<a name="l00287"></a>00287       <span class="comment">//cout &lt;&lt; &quot;process:: std::exception&quot; &lt;&lt; endl;</span>
<a name="l00288"></a>00288 
<a name="l00289"></a>00289       <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(e.what());
<a name="l00290"></a>00290    }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00296"></a><a class="code" href="classFIX8_1_1Session.html#abda2e814594f4238b9a6ee303f7fae93">00296</a> <span class="keywordtype">void</span> <a class="code" href="classFIX8_1_1Session.html#abda2e814594f4238b9a6ee303f7fae93">Session::compid_check</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> seqnum, <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg)
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298    <a class="code" href="structFIX8_1_1Field.html">sender_comp_id</a> sci;
<a name="l00299"></a>00299    msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(sci);
<a name="l00300"></a>00300    <a class="code" href="structFIX8_1_1Field.html">target_comp_id</a> tci;
<a name="l00301"></a>00301    msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(tci);
<a name="l00302"></a>00302    <span class="keywordflow">if</span> (!<a class="code" href="classFIX8_1_1Session.html#a99cd14ef90155a250f4bd721d9e798c4">_sid</a>.<a class="code" href="classFIX8_1_1SessionID.html#a1bf9f1d4481a8f1fdcac77cceefa1367">same_sender_comp_id</a>(tci))
<a name="l00303"></a>00303       <span class="keywordflow">throw</span> <a class="code" href="structFIX8_1_1BadCompidId.html" title="A message was received with an invalid sender/target compid id.">BadCompidId</a>(sci());
<a name="l00304"></a>00304    <span class="keywordflow">if</span> (!<a class="code" href="classFIX8_1_1Session.html#a99cd14ef90155a250f4bd721d9e798c4">_sid</a>.<a class="code" href="classFIX8_1_1SessionID.html#a0973dc2e178dfbf64236fe27dab0190b">same_target_comp_id</a>(sci))
<a name="l00305"></a>00305       <span class="keywordflow">throw</span> <a class="code" href="structFIX8_1_1BadCompidId.html" title="A message was received with an invalid sender/target compid id.">BadCompidId</a>(tci());
<a name="l00306"></a>00306 }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00309"></a><a class="code" href="classFIX8_1_1Session.html#a633b4c067941d09112acaa7efc452272">00309</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#a633b4c067941d09112acaa7efc452272">Session::sequence_check</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> seqnum, <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg)
<a name="l00310"></a>00310 {
<a name="l00311"></a>00311    <span class="comment">//cout &lt;&lt; &quot;seqnum:&quot; &lt;&lt; seqnum &lt;&lt; &quot; next_target_seq:&quot; &lt;&lt; _next_receive_seq</span>
<a name="l00312"></a>00312       <span class="comment">//&lt;&lt; &quot; next_sender_seq:&quot; &lt;&lt; _next_send_seq &lt;&lt; &quot; state:&quot; &lt;&lt; _state &lt;&lt; &quot; next_receive_seq:&quot; &lt;&lt;  _next_receive_seq &lt;&lt; endl;</span>
<a name="l00313"></a>00313 
<a name="l00314"></a>00314    <span class="keywordflow">if</span> (seqnum &gt; <a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a>)
<a name="l00315"></a>00315    {
<a name="l00316"></a>00316       <span class="comment">//if (_state == States::st_resend_request_sent)</span>
<a name="l00317"></a>00317 <span class="comment">//       log(&quot;Resend request already sent&quot;);</span>
<a name="l00318"></a>00318       <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> == <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8acc7d78a0eec3e2d88a2febfc2081b00a">States::st_continuous</a>)
<a name="l00319"></a>00319       {
<a name="l00320"></a>00320          <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *rmsg(<a class="code" href="classFIX8_1_1Session.html#aa625ec518594d5aef3eb499497ae31b4">generate_resend_request</a>(<a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a>));
<a name="l00321"></a>00321          <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a01f00075f0ca516073ad5fc1c138cd2d">States::st_resend_request_sent</a>;
<a name="l00322"></a>00322          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(rmsg);
<a name="l00323"></a>00323       }
<a name="l00324"></a>00324    <span class="comment">// else</span>
<a name="l00325"></a>00325    <span class="comment">//    throw InvalidMsgSequence(seqnum, _next_receive_seq);</span>
<a name="l00326"></a>00326       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00327"></a>00327    }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329    <span class="keywordflow">if</span> (seqnum &lt; <a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a>)
<a name="l00330"></a>00330    {
<a name="l00331"></a>00331       <a class="code" href="structFIX8_1_1Field.html" title="ABC field template. Partial specialisations of this class use Int2Type idiom.">poss_dup_flag</a> pdf(<span class="keyword">false</span>);
<a name="l00332"></a>00332       msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(pdf);
<a name="l00333"></a>00333       <span class="keywordflow">if</span> (!pdf()) <span class="comment">// poss dup not set so bad</span>
<a name="l00334"></a>00334          <span class="keywordflow">throw</span> <a class="code" href="structFIX8_1_1MsgSequenceTooLow.html" title="A message was received with an out of sequence sequence number.">MsgSequenceTooLow</a>(seqnum, <a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a>);
<a name="l00335"></a>00335       <a class="code" href="structFIX8_1_1Field.html" title="ABC field template. Partial specialisations of this class use Int2Type idiom.">sending_time</a> st;
<a name="l00336"></a>00336       msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(st);
<a name="l00337"></a>00337       <a class="code" href="structFIX8_1_1Field.html" title="ABC field template. Partial specialisations of this class use Int2Type idiom.">orig_sending_time</a> ost;
<a name="l00338"></a>00338       <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(ost) &amp;&amp; ost() &gt; st())
<a name="l00339"></a>00339       {
<a name="l00340"></a>00340          ostringstream ostr;
<a name="l00341"></a>00341          ost.<a class="code" href="classFIX8_1_1BaseField.html#a68b4265a14ab3ec76ef65ce8298c5b9c">print</a>(ostr);
<a name="l00342"></a>00342          <span class="keywordflow">throw</span> <a class="code" href="structFIX8_1_1BadSendingTime.html" title="A message was received with an invalid sending time.">BadSendingTime</a>(ostr.str());
<a name="l00343"></a>00343       }
<a name="l00344"></a>00344    }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00347"></a>00347 }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00350"></a><a class="code" href="classFIX8_1_1Session.html#a5dc4147c372c8f3a05f2bc29b1d8c1c5">00350</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#a5dc4147c372c8f3a05f2bc29b1d8c1c5">Session::handle_logon</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> seqnum, <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg)
<a name="l00351"></a>00351 {
<a name="l00352"></a>00352    <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a436b187afe7fbb64faf7bc72297f60ce">States::st_logon_received</a>;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#a5e55875fe93bcfcae541ddbcb250ac0b">get_role</a>() == <a class="code" href="classFIX8_1_1Connection.html#ac7c5a73f9b3727fce73c3240bb57e804a70ed88dfc473fbf4b1c8b48a8d8df290">Connection::cn_initiator</a>)
<a name="l00355"></a>00355    {
<a name="l00356"></a>00356       <a class="code" href="classFIX8_1_1Session.html#a755535b6a25422b7e13d32368113f5b4">enforce</a>(seqnum, msg);
<a name="l00357"></a>00357       <a class="code" href="structFIX8_1_1Field.html" title="ABC field template. Partial specialisations of this class use Int2Type idiom.">heartbeat_interval</a> hbi;
<a name="l00358"></a>00358       msg-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(hbi);
<a name="l00359"></a>00359       <a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#a62796cd45b362a0e14fbe2d6e0786710">set_hb_interval</a>(hbi());
<a name="l00360"></a>00360       <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8acc7d78a0eec3e2d88a2febfc2081b00a">States::st_continuous</a>;
<a name="l00361"></a>00361    }
<a name="l00362"></a>00362    <span class="keywordflow">else</span> <span class="comment">// acceptor</span>
<a name="l00363"></a>00363    {
<a name="l00364"></a>00364       <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#af9ff171d40c5f8747c2045bf7afb3041">_ctx</a>.<a class="code" href="structFIX8_1_1F8MetaCntx.html#ab1fc890f19e70e7391e8dbbd82367f39" title="4 digit fix version &lt;Major:1&gt;&lt;Minor:1&gt;&lt;Revision:2&gt; eg. 4.2r10 is 4210">version</a>() &gt;= 4100 &amp;&amp; msg-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a3552b4cf9b335f3d60ab579c27df12f0">have</a>(<a class="code" href="namespaceFIX8.html#a9d1f42c6256644b8e93a93722070b94b">Common_ResetSeqNumFlag</a>) &amp;&amp; msg-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>&lt;<a class="code" href="structFIX8_1_1Field.html" title="ABC field template. Partial specialisations of this class use Int2Type idiom.">reset_seqnum_flag</a>&gt;()-&gt;<span class="keyword">get</span>())
<a name="l00365"></a>00365       {
<a name="l00366"></a>00366          <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(<span class="stringliteral">&quot;Resetting sequence numbers&quot;</span>);
<a name="l00367"></a>00367          <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a> = <a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a> = 1;
<a name="l00368"></a>00368       }
<a name="l00369"></a>00369       <span class="keywordflow">else</span>
<a name="l00370"></a>00370       {
<a name="l00371"></a>00371          <a class="code" href="classFIX8_1_1Session.html#a6b44f0258866134e9da79723c50dafa4" title="Recover next expected and next to send sequence numbers from persitence layer.">recover_seqnums</a>();
<a name="l00372"></a>00372          <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#a24fd154f8f9d60dc5326c7be6be17aa7">_req_next_send_seq</a>)
<a name="l00373"></a>00373             <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a> = <a class="code" href="classFIX8_1_1Session.html#a24fd154f8f9d60dc5326c7be6be17aa7">_req_next_send_seq</a>;
<a name="l00374"></a>00374          <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#a91cdc6cbdb2d43cce4d16d73706be6e9">_req_next_receive_seq</a>)
<a name="l00375"></a>00375             <a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a> = <a class="code" href="classFIX8_1_1Session.html#a91cdc6cbdb2d43cce4d16d73706be6e9">_req_next_receive_seq</a>;
<a name="l00376"></a>00376       }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378       <a class="code" href="structFIX8_1_1Field.html">sender_comp_id</a> sci;
<a name="l00379"></a>00379       msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(sci);
<a name="l00380"></a>00380       <a class="code" href="structFIX8_1_1Field.html">target_comp_id</a> tci;
<a name="l00381"></a>00381       msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(tci);
<a name="l00382"></a>00382       <a class="code" href="classFIX8_1_1SessionID.html" title="Quickfix style sessionid.">SessionID</a> id(<a class="code" href="classFIX8_1_1Session.html#af9ff171d40c5f8747c2045bf7afb3041">_ctx</a>.<a class="code" href="structFIX8_1_1F8MetaCntx.html#ab60edf3bab787ab4d6447cc3b2cd2439" title="Fix header beginstring.">_beginStr</a>, tci(), sci());
<a name="l00383"></a>00383       <a class="code" href="structFIX8_1_1Field.html">default_appl_ver_id</a> davi;
<a name="l00384"></a>00384       msg-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(davi);
<a name="l00385"></a>00385       <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#a9cf063efca0742ad9973ad21cb718355">authenticate</a>(<span class="keywordtype">id</span>, msg))
<a name="l00386"></a>00386       {
<a name="l00387"></a>00387          <a class="code" href="classFIX8_1_1Session.html#a99cd14ef90155a250f4bd721d9e798c4">_sid</a> = id;
<a name="l00388"></a>00388          <a class="code" href="classFIX8_1_1Session.html#a755535b6a25422b7e13d32368113f5b4">enforce</a>(seqnum, msg);
<a name="l00389"></a>00389          <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Session.html#af6a1b902be5e2e2d282317bfc7c76110">generate_logon</a>(<a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#a4ef6dd0e741a007bf9261cb44f8e5de1">get_hb_interval</a>(), davi()));
<a name="l00390"></a>00390          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(msg);
<a name="l00391"></a>00391          <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8acc7d78a0eec3e2d88a2febfc2081b00a">States::st_continuous</a>;
<a name="l00392"></a>00392       }
<a name="l00393"></a>00393       <span class="keywordflow">else</span>
<a name="l00394"></a>00394       {
<a name="l00395"></a>00395          ostringstream ostr;
<a name="l00396"></a>00396          ostr &lt;&lt; <span class="keywordtype">id</span> &lt;&lt; <span class="stringliteral">&quot; failed authentication&quot;</span>;
<a name="l00397"></a>00397          <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(ostr.str());
<a name="l00398"></a>00398          <a class="code" href="classFIX8_1_1Session.html#ae4c637cd36d88ddac5a1db2565f82ef1" title="stop the session.">stop</a>();
<a name="l00399"></a>00399          <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8aa87dce412b93369b7da514df2ad1bcfb">States::st_session_terminated</a>;
<a name="l00400"></a>00400          <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00401"></a>00401       }
<a name="l00402"></a>00402    }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404    ostringstream ostr;
<a name="l00405"></a>00405    ostr &lt;&lt; <span class="stringliteral">&quot;Heartbeat interval is &quot;</span> &lt;&lt; <a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#a4ef6dd0e741a007bf9261cb44f8e5de1">get_hb_interval</a>();
<a name="l00406"></a>00406    <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(ostr.str());
<a name="l00407"></a>00407 
<a name="l00408"></a>00408    <a class="code" href="classFIX8_1_1Session.html#a913639843c4d5fec356c564d69235717">_timer</a>.<a class="code" href="classFIX8_1_1Timer.html#a67273582c31d26851df37b284d1256cc">schedule</a>(<a class="code" href="classFIX8_1_1Session.html#a0c38e60ca2bbdb96733f6ba831ca2ab5">_hb_processor</a>, 1000);  <span class="comment">// check every second</span>
<a name="l00409"></a>00409 
<a name="l00410"></a>00410    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00414"></a><a class="code" href="classFIX8_1_1Session.html#a29bd6e9852f4af85a6ecd22ef4ae2dcb">00414</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#a29bd6e9852f4af85a6ecd22ef4ae2dcb">Session::handle_logout</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> seqnum, <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg)
<a name="l00415"></a>00415 {
<a name="l00416"></a>00416    <a class="code" href="classFIX8_1_1Session.html#a755535b6a25422b7e13d32368113f5b4">enforce</a>(seqnum, msg);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418    <span class="comment">//if (_state != States::st_logoff_sent)</span>
<a name="l00419"></a>00419    <span class="comment">// send(generate_logout());</span>
<a name="l00420"></a>00420    <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(<span class="stringliteral">&quot;peer has logged out&quot;</span>);
<a name="l00421"></a>00421    <a class="code" href="classFIX8_1_1Session.html#ae4c637cd36d88ddac5a1db2565f82ef1" title="stop the session.">stop</a>();
<a name="l00422"></a>00422    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00423"></a>00423 }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00426"></a><a class="code" href="classFIX8_1_1Session.html#aa9c2ec078b93b45b4b8a591ea676881b">00426</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#aa9c2ec078b93b45b4b8a591ea676881b">Session::handle_sequence_reset</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> seqnum, <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428    <a class="code" href="classFIX8_1_1Session.html#a755535b6a25422b7e13d32368113f5b4">enforce</a>(seqnum, msg);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430    <a class="code" href="structFIX8_1_1Field.html" title="ABC field template. Partial specialisations of this class use Int2Type idiom.">new_seq_num</a> nsn;
<a name="l00431"></a>00431    <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(nsn))
<a name="l00432"></a>00432    {
<a name="l00433"></a>00433       <span class="keywordflow">if</span> (nsn() &gt; <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a>))
<a name="l00434"></a>00434          <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a> = nsn();
<a name="l00435"></a>00435       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nsn() &lt; static_cast&lt;int&gt;(<a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a>))
<a name="l00436"></a>00436          <span class="keywordflow">throw</span> <a class="code" href="structFIX8_1_1MsgSequenceTooLow.html" title="A message was received with an out of sequence sequence number.">MsgSequenceTooLow</a>(nsn(), <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a>);
<a name="l00437"></a>00437    }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> == <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a01f00075f0ca516073ad5fc1c138cd2d">States::st_resend_request_sent</a>)
<a name="l00440"></a>00440       <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8acc7d78a0eec3e2d88a2febfc2081b00a">States::st_continuous</a>;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00446"></a><a class="code" href="classFIX8_1_1Session.html#a3225a1c0290539638f2051a6c63b39a5">00446</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#a3225a1c0290539638f2051a6c63b39a5">Session::handle_resend_request</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> seqnum, <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg)
<a name="l00447"></a>00447 {
<a name="l00448"></a>00448    <a class="code" href="classFIX8_1_1Session.html#a755535b6a25422b7e13d32368113f5b4">enforce</a>(seqnum, msg);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> != <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a0dd43ce91b6bb7552dc5361e88e58425">States::st_resend_request_received</a>)
<a name="l00451"></a>00451    {
<a name="l00452"></a>00452       <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a0dd43ce91b6bb7552dc5361e88e58425">States::st_resend_request_received</a>;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454       <a class="code" href="structFIX8_1_1Field.html" title="ABC field template. Partial specialisations of this class use Int2Type idiom.">begin_seq_num</a> begin;
<a name="l00455"></a>00455       <a class="code" href="structFIX8_1_1Field.html" title="ABC field template. Partial specialisations of this class use Int2Type idiom.">end_seq_num</a> end;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457       <span class="keywordflow">if</span> (!<a class="code" href="classFIX8_1_1Session.html#acb236bba1eca3b8c6a636b74425aa574">_persist</a> || !msg-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(begin) || !msg-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(end))
<a name="l00458"></a>00458          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(<a class="code" href="classFIX8_1_1Session.html#a7670d7d518853e323a6d9006c4256b5b">generate_sequence_reset</a>(<a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a> + 1, <span class="keyword">true</span>));
<a name="l00459"></a>00459       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((begin() &gt; end() &amp;&amp; end()) || begin() == 0)
<a name="l00460"></a>00460          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(<a class="code" href="classFIX8_1_1Session.html#a2c1493ab549b191101c95bb8bb6d0afa">generate_reject</a>(seqnum, <span class="stringliteral">&quot;Invalid begin or end resend seqnum&quot;</span>));
<a name="l00461"></a>00461       <span class="keywordflow">else</span>
<a name="l00462"></a>00462          <a class="code" href="classFIX8_1_1Session.html#acb236bba1eca3b8c6a636b74425aa574">_persist</a>-&gt;<a class="code" href="classFIX8_1_1Persister.html#a3e2bdbad7444ae43e26a3fb82bcaf613">get</a>(begin(), end(), *<span class="keyword">this</span>, &amp;<a class="code" href="classFIX8_1_1Session.html#a1d262e8d9d794c158415ac20cd420400">Session::retrans_callback</a>);
<a name="l00463"></a>00463    }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00469"></a><a class="code" href="classFIX8_1_1Session.html#a1d262e8d9d794c158415ac20cd420400">00469</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#a1d262e8d9d794c158415ac20cd420400">Session::retrans_callback</a>(<span class="keyword">const</span> <a class="code" href="classFIX8_1_1Session.html#ae9ef38b606a6a2dbe98d7977f381bb95">SequencePair</a>&amp; with, <a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html" title="Provides context to your retrans handler.">RetransmissionContext</a>&amp; rctx)
<a name="l00470"></a>00470 {
<a name="l00471"></a>00471    <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Message.html#a825a6117953bc9ea2f3ac99a00c81037">Message::factory</a>(<a class="code" href="classFIX8_1_1Session.html#af9ff171d40c5f8747c2045bf7afb3041">_ctx</a>, with.second));
<a name="l00472"></a>00472 
<a name="l00473"></a>00473    <span class="comment">//cout &lt;&lt; &quot;first:&quot; &lt;&lt; with.first &lt;&lt; &#39; &#39; &lt;&lt; rctx &lt;&lt; endl;</span>
<a name="l00474"></a>00474 
<a name="l00475"></a>00475    <span class="keywordflow">if</span> (rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#a33b84ac348192c6eab1ebd457c12c4e4">_no_more_records</a>)
<a name="l00476"></a>00476    {
<a name="l00477"></a>00477       <span class="keywordflow">if</span> (rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#aa1f9b776075735463bb8d213caabd3dc">_end</a>)
<a name="l00478"></a>00478       {
<a name="l00479"></a>00479          <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a> = rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#a5bcc392356fcb1cb10f32b7546042a7e">_interrupted_seqnum</a> - 1;
<a name="l00480"></a>00480          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(<a class="code" href="classFIX8_1_1Session.html#a7670d7d518853e323a6d9006c4256b5b">generate_sequence_reset</a>(rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#a5bcc392356fcb1cb10f32b7546042a7e">_interrupted_seqnum</a>, <span class="keyword">true</span>), rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#a90c43f8d2aeb61210d1879f7708daded">_last</a> + 1);
<a name="l00481"></a>00481          <span class="comment">//cout &lt;&lt; &quot;#1&quot; &lt;&lt; endl;</span>
<a name="l00482"></a>00482       }
<a name="l00483"></a>00483       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#a90c43f8d2aeb61210d1879f7708daded">_last</a>)
<a name="l00484"></a>00484       {
<a name="l00485"></a>00485          <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a> = rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#a5bcc392356fcb1cb10f32b7546042a7e">_interrupted_seqnum</a>;
<a name="l00486"></a>00486          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(<a class="code" href="classFIX8_1_1Session.html#a7670d7d518853e323a6d9006c4256b5b">generate_sequence_reset</a>(rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#a5bcc392356fcb1cb10f32b7546042a7e">_interrupted_seqnum</a>, <span class="keyword">true</span>));
<a name="l00487"></a>00487          <span class="comment">//cout &lt;&lt; &quot;#4&quot; &lt;&lt; endl;</span>
<a name="l00488"></a>00488       }
<a name="l00489"></a>00489       <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8acc7d78a0eec3e2d88a2febfc2081b00a">States::st_continuous</a>;
<a name="l00490"></a>00490       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00491"></a>00491    }
<a name="l00492"></a>00492 
<a name="l00493"></a>00493    <span class="keywordflow">if</span> (rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#a90c43f8d2aeb61210d1879f7708daded">_last</a>)
<a name="l00494"></a>00494    {
<a name="l00495"></a>00495       <span class="keywordflow">if</span> (rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#a90c43f8d2aeb61210d1879f7708daded">_last</a> + 1 &lt; with.first)
<a name="l00496"></a>00496       {
<a name="l00497"></a>00497          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(<a class="code" href="classFIX8_1_1Session.html#a7670d7d518853e323a6d9006c4256b5b">generate_sequence_reset</a>(with.first, <span class="keyword">true</span>), <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a>);
<a name="l00498"></a>00498          <span class="comment">//cout &lt;&lt; &quot;#2&quot; &lt;&lt; endl;</span>
<a name="l00499"></a>00499       }
<a name="l00500"></a>00500    }
<a name="l00501"></a>00501    <span class="keywordflow">else</span>
<a name="l00502"></a>00502    {
<a name="l00503"></a>00503       <span class="keywordflow">if</span> (with.first &gt; rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#ae1b896885ae42bc613e2b686ac7315bd">_begin</a>)
<a name="l00504"></a>00504       {
<a name="l00505"></a>00505          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(<a class="code" href="classFIX8_1_1Session.html#a7670d7d518853e323a6d9006c4256b5b">generate_sequence_reset</a>(with.first, <span class="keyword">true</span>));
<a name="l00506"></a>00506          <span class="comment">//cout &lt;&lt; &quot;#3&quot; &lt;&lt; endl;</span>
<a name="l00507"></a>00507       }
<a name="l00508"></a>00508    }
<a name="l00509"></a>00509 
<a name="l00510"></a>00510    rctx.<a class="code" href="structFIX8_1_1Session_1_1RetransmissionContext.html#a90c43f8d2aeb61210d1879f7708daded">_last</a> = with.first;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512    <span class="keywordflow">return</span> <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(msg);
<a name="l00513"></a>00513 }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00516"></a><a class="code" href="classFIX8_1_1Session.html#ae26764de9f1b7da26f1659de8b146aeb">00516</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#ae26764de9f1b7da26f1659de8b146aeb">Session::handle_test_request</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> seqnum, <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg)
<a name="l00517"></a>00517 {
<a name="l00518"></a>00518    <a class="code" href="classFIX8_1_1Session.html#a755535b6a25422b7e13d32368113f5b4">enforce</a>(seqnum, msg);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520    <a class="code" href="structFIX8_1_1Field.html" title="ABC field template. Partial specialisations of this class use Int2Type idiom.">test_request_id</a> testReqID;
<a name="l00521"></a>00521    msg-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(testReqID);
<a name="l00522"></a>00522    <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *trmsg(<a class="code" href="classFIX8_1_1Session.html#ac440b00a9d7b93e5b37e5cd78a60bb43">generate_heartbeat</a>(testReqID()));
<a name="l00523"></a>00523    <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(trmsg);
<a name="l00524"></a>00524    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00525"></a>00525 }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00528"></a><a class="code" href="classFIX8_1_1Session.html#abc077cc755603e29b80291c3072a3165">00528</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#abc077cc755603e29b80291c3072a3165" title="Heartbeat generation service thread.">Session::heartbeat_service</a>()
<a name="l00529"></a>00529 {
<a name="l00530"></a>00530    <a class="code" href="classFIX8_1_1Tickval.html" title="High resolution time in nanosecond ticks.">Tickval</a> now(<span class="keyword">true</span>);
<a name="l00531"></a>00531    <span class="keywordflow">if</span> ((now - *<a class="code" href="classFIX8_1_1Session.html#a8bb5b91c87ef07a96abe77464e3cb1cc">_last_sent</a>).secs() &gt;= <a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#a4ef6dd0e741a007bf9261cb44f8e5de1">get_hb_interval</a>())
<a name="l00532"></a>00532    {
<a name="l00533"></a>00533       <span class="keyword">const</span> <a class="code" href="namespaceFIX8.html#a653abc4baa49d96ad764ffc8f3dce148">f8String</a> testReqID;
<a name="l00534"></a>00534       <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Session.html#ac440b00a9d7b93e5b37e5cd78a60bb43">generate_heartbeat</a>(testReqID));
<a name="l00535"></a>00535       <span class="comment">//if (_connection-&gt;get_role() == Connection::cn_initiator)</span>
<a name="l00536"></a>00536          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(msg);
<a name="l00537"></a>00537    }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539    now.<a class="code" href="classFIX8_1_1Tickval.html#a9a7c3f6ef8335a4b201d075b798896b2">now</a>();
<a name="l00540"></a>00540    <span class="keywordflow">if</span> ((now - *<a class="code" href="classFIX8_1_1Session.html#a39d0ae002b22f23d3a644bf4dcbb15b2">_last_received</a>).secs() &gt; <a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#aefab997da9ecf3529a3a997e58ccc1cf">get_hb_interval20pc</a>())
<a name="l00541"></a>00541    {
<a name="l00542"></a>00542       <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> == <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a82a6dbc42444e11e47ee5a8a27635f60">States::st_test_request_sent</a>)  <span class="comment">// already sent</span>
<a name="l00543"></a>00543       {
<a name="l00544"></a>00544          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(<a class="code" href="classFIX8_1_1Session.html#abc1e0fa8b9619aa66d6c59b21e25da78">generate_logout</a>(), 0, <span class="keyword">true</span>); <span class="comment">// so it won&#39;t increment</span>
<a name="l00545"></a>00545          <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a385060f5590bc613b4df74d8b3bced56">States::st_logoff_sent</a>;
<a name="l00546"></a>00546          <a class="code" href="classFIX8_1_1Session.html#ae4c637cd36d88ddac5a1db2565f82ef1" title="stop the session.">stop</a>();
<a name="l00547"></a>00547          <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00548"></a>00548       }
<a name="l00549"></a>00549       <span class="keywordflow">else</span>
<a name="l00550"></a>00550       {
<a name="l00551"></a>00551          <span class="keyword">const</span> <a class="code" href="namespaceFIX8.html#a653abc4baa49d96ad764ffc8f3dce148">f8String</a> testReqID(<span class="stringliteral">&quot;TEST&quot;</span>);
<a name="l00552"></a>00552          <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(<a class="code" href="classFIX8_1_1Session.html#a06a794d133478efaa9d08af9e78f0552">generate_test_request</a>(testReqID));
<a name="l00553"></a>00553          <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a82a6dbc42444e11e47ee5a8a27635f60">States::st_test_request_sent</a>;
<a name="l00554"></a>00554       }
<a name="l00555"></a>00555    }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557    <a class="code" href="classFIX8_1_1Session.html#a913639843c4d5fec356c564d69235717">_timer</a>.<a class="code" href="classFIX8_1_1Timer.html#a67273582c31d26851df37b284d1256cc">schedule</a>(<a class="code" href="classFIX8_1_1Session.html#a0c38e60ca2bbdb96733f6ba831ca2ab5">_hb_processor</a>, 1000);
<a name="l00558"></a>00558 
<a name="l00559"></a>00559    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00560"></a>00560 }
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00563"></a><a class="code" href="classFIX8_1_1Session.html#ae5bf54b50e2ef6ef06532e7bbe535604">00563</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#ae5bf54b50e2ef6ef06532e7bbe535604">Session::handle_heartbeat</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> seqnum, <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg)
<a name="l00564"></a>00564 {
<a name="l00565"></a>00565    <a class="code" href="classFIX8_1_1Session.html#a755535b6a25422b7e13d32368113f5b4">enforce</a>(seqnum, msg);
<a name="l00566"></a>00566 
<a name="l00567"></a>00567    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> == <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8a82a6dbc42444e11e47ee5a8a27635f60">States::st_test_request_sent</a>)
<a name="l00568"></a>00568       <a class="code" href="classFIX8_1_1Session.html#acc1d774f3e3e612ff83b0879ebc0f065">_state</a> = <a class="code" href="structFIX8_1_1States.html#a95240585037fdfcc9ac6ee61133cd4e8acc7d78a0eec3e2d88a2febfc2081b00a">States::st_continuous</a>;
<a name="l00569"></a>00569    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00570"></a>00570 }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00573"></a><a class="code" href="classFIX8_1_1Session.html#ac440b00a9d7b93e5b37e5cd78a60bb43">00573</a> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *<a class="code" href="classFIX8_1_1Session.html#ac440b00a9d7b93e5b37e5cd78a60bb43">Session::generate_heartbeat</a>(<span class="keyword">const</span> <a class="code" href="namespaceFIX8.html#a653abc4baa49d96ad764ffc8f3dce148">f8String</a>&amp; testReqID)
<a name="l00574"></a>00574 {
<a name="l00575"></a>00575    <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Session.html#a03cf7d0242f543446b60617a4ed3b346">create_msg</a>(<a class="code" href="namespaceFIX8.html#aa30604797b7d0eb424f057eea0d40120">Common_MsgType_HEARTBEAT</a>));
<a name="l00576"></a>00576    <span class="keywordflow">if</span> (!testReqID.empty())
<a name="l00577"></a>00577       *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#af38f8546dd0f7154491b559f13d7830d">test_request_id</a>(testReqID);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579    <span class="keywordflow">return</span> msg;
<a name="l00580"></a>00580 }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00583"></a><a class="code" href="classFIX8_1_1Session.html#a2c1493ab549b191101c95bb8bb6d0afa">00583</a> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *<a class="code" href="classFIX8_1_1Session.html#a2c1493ab549b191101c95bb8bb6d0afa">Session::generate_reject</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> seqnum, <span class="keyword">const</span> <span class="keywordtype">char</span> *what)
<a name="l00584"></a>00584 {
<a name="l00585"></a>00585    <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Session.html#a03cf7d0242f543446b60617a4ed3b346">create_msg</a>(<a class="code" href="namespaceFIX8.html#ac50be7cf0a144e9b4caff37eae3b3d53">Common_MsgType_REJECT</a>));
<a name="l00586"></a>00586    *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a215ffd661d6ed362df590d92d1b45e77">ref_seq_num</a>(seqnum);
<a name="l00587"></a>00587    <span class="keywordflow">if</span> (what)
<a name="l00588"></a>00588       *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a66c37e12f4ea8b8913cdc5754dba633a">text</a>(what);
<a name="l00589"></a>00589    <span class="keywordflow">return</span> msg;
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00593"></a><a class="code" href="classFIX8_1_1Session.html#a06a794d133478efaa9d08af9e78f0552">00593</a> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *<a class="code" href="classFIX8_1_1Session.html#a06a794d133478efaa9d08af9e78f0552">Session::generate_test_request</a>(<span class="keyword">const</span> <a class="code" href="namespaceFIX8.html#a653abc4baa49d96ad764ffc8f3dce148">f8String</a>&amp; testReqID)
<a name="l00594"></a>00594 {
<a name="l00595"></a>00595    <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Session.html#a03cf7d0242f543446b60617a4ed3b346">create_msg</a>(<a class="code" href="namespaceFIX8.html#ab81da725128a9689b97c5db7fa6c1a0e">Common_MsgType_TEST_REQUEST</a>));
<a name="l00596"></a>00596    *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#af38f8546dd0f7154491b559f13d7830d">test_request_id</a>(testReqID);
<a name="l00597"></a>00597 
<a name="l00598"></a>00598    <span class="keywordflow">return</span> msg;
<a name="l00599"></a>00599 }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00602"></a><a class="code" href="classFIX8_1_1Session.html#af6a1b902be5e2e2d282317bfc7c76110">00602</a> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *<a class="code" href="classFIX8_1_1Session.html#af6a1b902be5e2e2d282317bfc7c76110">Session::generate_logon</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> heartbtint, <span class="keyword">const</span> <a class="code" href="namespaceFIX8.html#a653abc4baa49d96ad764ffc8f3dce148">f8String</a> davi)
<a name="l00603"></a>00603 {
<a name="l00604"></a>00604    <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Session.html#a03cf7d0242f543446b60617a4ed3b346">create_msg</a>(<a class="code" href="namespaceFIX8.html#a35904f2126893066927ae534f6bc95ed">Common_MsgType_LOGON</a>));
<a name="l00605"></a>00605    *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a4f85ab9749c27019b9b0fe00e16421e6">heartbeat_interval</a>(heartbtint);
<a name="l00606"></a>00606    *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#aaddf77e8657f5f98d26e2b1190e5163f">encrypt_method</a>(0); <span class="comment">// FIXME</span>
<a name="l00607"></a>00607    <span class="keywordflow">if</span> (!davi.empty())
<a name="l00608"></a>00608       *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a69fe800cc26bea9e90d65c92e5509b95">default_appl_ver_id</a>(davi);
<a name="l00609"></a>00609    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#ac4617326be134747e0682dfe6a70a932">_reset_sequence_numbers</a>)
<a name="l00610"></a>00610       *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a1ce9d9e9cb4eae3164cc738b14a9477a">reset_seqnum_flag</a>(<span class="keyword">true</span>);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612    <span class="keywordflow">return</span> msg;
<a name="l00613"></a>00613 }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00616"></a><a class="code" href="classFIX8_1_1Session.html#abc1e0fa8b9619aa66d6c59b21e25da78">00616</a> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *<a class="code" href="classFIX8_1_1Session.html#abc1e0fa8b9619aa66d6c59b21e25da78">Session::generate_logout</a>()
<a name="l00617"></a>00617 {
<a name="l00618"></a>00618    <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Session.html#a03cf7d0242f543446b60617a4ed3b346">create_msg</a>(<a class="code" href="namespaceFIX8.html#a7b0993ad8aff8a082fff252e62222475">Common_MsgType_LOGOUT</a>));
<a name="l00619"></a>00619    <span class="keywordflow">return</span> msg;
<a name="l00620"></a>00620 }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00623"></a><a class="code" href="classFIX8_1_1Session.html#aa625ec518594d5aef3eb499497ae31b4">00623</a> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *<a class="code" href="classFIX8_1_1Session.html#aa625ec518594d5aef3eb499497ae31b4">Session::generate_resend_request</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> begin, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> end)
<a name="l00624"></a>00624 {
<a name="l00625"></a>00625    <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Session.html#a03cf7d0242f543446b60617a4ed3b346">create_msg</a>(<a class="code" href="namespaceFIX8.html#a335f1df36e788ddcb1019dbc7c3fd0ce">Common_MsgType_RESEND_REQUEST</a>));
<a name="l00626"></a>00626    *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a87d817bfb0d49a2065ca2b6dd7f607a4">begin_seq_num</a>(begin);
<a name="l00627"></a>00627    *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a9c53898deba54e483df3ac9152cbed79">end_seq_num</a>(end);
<a name="l00628"></a>00628 
<a name="l00629"></a>00629    <span class="keywordflow">return</span> msg;
<a name="l00630"></a>00630 }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00633"></a><a class="code" href="classFIX8_1_1Session.html#a7670d7d518853e323a6d9006c4256b5b">00633</a> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *<a class="code" href="classFIX8_1_1Session.html#a7670d7d518853e323a6d9006c4256b5b">Session::generate_sequence_reset</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> newseqnum, <span class="keyword">const</span> <span class="keywordtype">bool</span> gapfillflag)
<a name="l00634"></a>00634 {
<a name="l00635"></a>00635    <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg(<a class="code" href="classFIX8_1_1Session.html#a03cf7d0242f543446b60617a4ed3b346">create_msg</a>(<a class="code" href="namespaceFIX8.html#a77cd307386bbd382d44d0872ee70a7b5">Common_MsgType_SEQUENCE_RESET</a>));
<a name="l00636"></a>00636    *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#aa50069ad6e826aa0c986d02689917c98">new_seq_num</a>(newseqnum);
<a name="l00637"></a>00637 
<a name="l00638"></a>00638    <span class="keywordflow">if</span> (gapfillflag)
<a name="l00639"></a>00639       *msg += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a801cd68b829c69efb7139d975fb4fb97">gap_fill_flag</a>(<span class="keyword">true</span>);
<a name="l00640"></a>00640 
<a name="l00641"></a>00641    <span class="keywordflow">return</span> msg;
<a name="l00642"></a>00642 }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00645"></a><a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">00645</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">Session::send</a>(<a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *tosend, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> custom_seqnum, <span class="keyword">const</span> <span class="keywordtype">bool</span> no_increment)
<a name="l00646"></a>00646 {
<a name="l00647"></a>00647    <span class="keywordflow">if</span> (custom_seqnum)
<a name="l00648"></a>00648       tosend-&gt;<a class="code" href="classFIX8_1_1Message.html#a49265808bcd1aba9ff87181fedd593ed">set_custom_seqnum</a>(custom_seqnum);
<a name="l00649"></a>00649    <span class="keywordflow">if</span> (no_increment)
<a name="l00650"></a>00650       tosend-&gt;<a class="code" href="classFIX8_1_1Message.html#a35a747daba277ae9a97b21065129d4f4">set_no_increment</a>(no_increment);
<a name="l00651"></a>00651    <span class="keywordflow">return</span> <a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#a2daf511c15cdfdb04bcade284e63292b">write</a>(tosend);
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 <span class="preprocessor">#if defined MSGRECYCLING</span>
<a name="l00655"></a><a class="code" href="classFIX8_1_1Session.html#ac9ed55f61e7d0aa57c36a47d42af2b88">00655</a> <span class="preprocessor"></span><span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#ac9ed55f61e7d0aa57c36a47d42af2b88">Session::send_wait</a>(<a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> custom_seqnum, <span class="keyword">const</span> <span class="keywordtype">int</span> waitval)
<a name="l00656"></a>00656 {
<a name="l00657"></a>00657    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#a3598effb83b3912939e2841826adbdd0">send</a>(msg, custom_seqnum))
<a name="l00658"></a>00658    {
<a name="l00659"></a>00659       <span class="keywordflow">while</span>(msg-&gt;<a class="code" href="classFIX8_1_1Message.html#a7bae825539a347708fc047d480ef66e0">get_in_use</a>())
<a name="l00660"></a>00660          <a class="code" href="namespaceFIX8.html#aa1b06f6428a6ffeff42a14d0fee0d17f">microsleep</a>(waitval);
<a name="l00661"></a>00661       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00662"></a>00662    }
<a name="l00663"></a>00663    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00664"></a>00664 }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666 <span class="preprocessor">#endif</span>
<a name="l00667"></a>00667 <span class="preprocessor"></span>
<a name="l00668"></a>00668 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00669"></a><a class="code" href="classFIX8_1_1Session.html#a07611f696bffa6982dfa5b340ee9524f">00669</a> <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#a07611f696bffa6982dfa5b340ee9524f">Session::send_process</a>(<a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg) <span class="comment">// called from the connection thread</span>
<a name="l00670"></a>00670 {
<a name="l00671"></a>00671    <span class="keywordtype">bool</span> is_dup(msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a3552b4cf9b335f3d60ab579c27df12f0">have</a>(<a class="code" href="namespaceFIX8.html#a94b18f42f9cfee61baeae57edcc6446e">Common_PossDupFlag</a>));
<a name="l00672"></a>00672 
<a name="l00673"></a>00673    <span class="keywordflow">if</span> (!msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a3552b4cf9b335f3d60ab579c27df12f0">have</a>(<a class="code" href="namespaceFIX8.html#af4f083668b39eb05601f70760add99dd">Common_SenderCompID</a>))
<a name="l00674"></a>00674       *msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>() += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a3814ce0293e9d5fd61fb398aaa383369">sender_comp_id</a>(<a class="code" href="classFIX8_1_1Session.html#a99cd14ef90155a250f4bd721d9e798c4">_sid</a>.<a class="code" href="classFIX8_1_1SessionID.html#ae04a5c1c434de1bc5725b2007ff5f70b">get_senderCompID</a>());
<a name="l00675"></a>00675    <span class="keywordflow">if</span> (!msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a3552b4cf9b335f3d60ab579c27df12f0">have</a>(<a class="code" href="namespaceFIX8.html#ae954b6d79778b6006f9fb8fccfb52a3b">Common_TargetCompID</a>))
<a name="l00676"></a>00676       *msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>() += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a24883f3659515b6e800735c3123cf68e">target_comp_id</a>(<a class="code" href="classFIX8_1_1Session.html#a99cd14ef90155a250f4bd721d9e798c4">_sid</a>.<a class="code" href="classFIX8_1_1SessionID.html#a9cdbc97fa63ccff7bfbbb244fed06887">get_targetCompID</a>());
<a name="l00677"></a>00677 
<a name="l00678"></a>00678    <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a3552b4cf9b335f3d60ab579c27df12f0">have</a>(<a class="code" href="namespaceFIX8.html#a553ab7c89eaaff1d81511fa35c7b0e56">Common_MsgSeqNum</a>))
<a name="l00679"></a>00679    {
<a name="l00680"></a>00680       <span class="keywordflow">if</span> (!is_dup)
<a name="l00681"></a>00681       {
<a name="l00682"></a>00682          *msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>() += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a2f088bab913bf7fd350c2039356c4bf9">poss_dup_flag</a>(<span class="keyword">true</span>);
<a name="l00683"></a>00683          is_dup = <span class="keyword">true</span>;
<a name="l00684"></a>00684       }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686       <a class="code" href="structFIX8_1_1Field.html" title="ABC field template. Partial specialisations of this class use Int2Type idiom.">sending_time</a> sendtime;
<a name="l00687"></a>00687       msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>()-&gt;<a class="code" href="classFIX8_1_1MessageBase.html#a5931e37660892b4ecb237dec4615ee50">get</a>(sendtime);
<a name="l00688"></a>00688       *msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>() += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#a225d864f536b71ed6769bb87630914c9">orig_sending_time</a>(sendtime());
<a name="l00689"></a>00689    }
<a name="l00690"></a>00690    <span class="keywordflow">else</span>
<a name="l00691"></a>00691       *msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>() += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#ad416b42d381b07f4d20fb8bdb5762af3">msg_seq_num</a>(msg-&gt;<a class="code" href="classFIX8_1_1Message.html#aadb73f4aee08970d4c42ba702631c3fb">get_custom_seqnum</a>() ? msg-&gt;<a class="code" href="classFIX8_1_1Message.html#aadb73f4aee08970d4c42ba702631c3fb">get_custom_seqnum</a>() : <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a>);
<a name="l00692"></a>00692    *msg-&gt;<a class="code" href="classFIX8_1_1Message.html#ad81fbafc964c2a7a8e12c7becbb94272">Header</a>() += <span class="keyword">new</span> <a class="code" href="namespaceFIX8.html#ad947c7044870bbe6c14fa00bc7c3a1af">sending_time</a>;
<a name="l00693"></a>00693 
<a name="l00694"></a>00694    <span class="keywordflow">try</span>
<a name="l00695"></a>00695    {
<a name="l00696"></a>00696       <span class="comment">//cout &lt;&lt; &quot;Sending:&quot; &lt;&lt; *msg;</span>
<a name="l00697"></a>00697       <a class="code" href="classFIX8_1_1Session.html#af24127d02e1e6083789a5b1e1e2c78d8">modify_outbound</a>(msg);
<a name="l00698"></a>00698       <a class="code" href="namespaceFIX8.html#a653abc4baa49d96ad764ffc8f3dce148">f8String</a> output;
<a name="l00699"></a>00699       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> enclen(msg-&gt;<a class="code" href="classFIX8_1_1Message.html#a72496b83546f9d52bbf87527c447b641">encode</a>(output));
<a name="l00700"></a>00700       <span class="keywordflow">if</span> (!<a class="code" href="classFIX8_1_1Session.html#a86ae39a6c7897426bd45d8577aca8692">_connection</a>-&gt;<a class="code" href="classFIX8_1_1Connection.html#abfff6f1008357a229125ded4b3946b47">send</a>(output))
<a name="l00701"></a>00701       {
<a name="l00702"></a>00702          ostringstream ostr;
<a name="l00703"></a>00703          ostr &lt;&lt; <span class="stringliteral">&quot;Message write failed: &quot;</span> &lt;&lt; enclen;
<a name="l00704"></a>00704          <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(ostr.str());
<a name="l00705"></a>00705          <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00706"></a>00706       }
<a name="l00707"></a>00707       <a class="code" href="classFIX8_1_1Session.html#a8bb5b91c87ef07a96abe77464e3cb1cc">_last_sent</a>-&gt;now();
<a name="l00708"></a>00708       <a class="code" href="classFIX8_1_1Session.html#a8fc99dac42d6cd940954dc575671c522">plog</a>(output);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710       <span class="comment">//cout &lt;&lt; &quot;send_process&quot; &lt;&lt; endl;</span>
<a name="l00711"></a>00711 
<a name="l00712"></a>00712       <span class="keywordflow">if</span> (!is_dup)
<a name="l00713"></a>00713       {
<a name="l00714"></a>00714          <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acb236bba1eca3b8c6a636b74425aa574">_persist</a>)
<a name="l00715"></a>00715          {
<a name="l00716"></a>00716             <span class="keywordflow">if</span> (!msg-&gt;<a class="code" href="classFIX8_1_1Message.html#a0d94fdcac5c21ee76b99417db9a85c3b">is_admin</a>())
<a name="l00717"></a>00717                <a class="code" href="classFIX8_1_1Session.html#acb236bba1eca3b8c6a636b74425aa574">_persist</a>-&gt;<a class="code" href="classFIX8_1_1Persister.html#a2318928465e09f9c0b8973258e8f3add">put</a>(<a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a>, output);
<a name="l00718"></a>00718             <a class="code" href="classFIX8_1_1Session.html#acb236bba1eca3b8c6a636b74425aa574">_persist</a>-&gt;<a class="code" href="classFIX8_1_1Persister.html#a2318928465e09f9c0b8973258e8f3add">put</a>(<a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a> + 1, <a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a>);
<a name="l00719"></a>00719             <span class="comment">//cout &lt;&lt; &quot;Persisted (send):&quot; &lt;&lt; (_next_send_seq + 1) &lt;&lt; &quot; and &quot; &lt;&lt; _next_receive_seq &lt;&lt; endl;</span>
<a name="l00720"></a>00720          }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722          <span class="keywordflow">if</span> (!msg-&gt;<a class="code" href="classFIX8_1_1Message.html#aadb73f4aee08970d4c42ba702631c3fb">get_custom_seqnum</a>() &amp;&amp; !msg-&gt;<a class="code" href="classFIX8_1_1Message.html#a117f8048127b51e211f1f09536a95e50">get_no_increment</a>())
<a name="l00723"></a>00723          {
<a name="l00724"></a>00724             ++<a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a>;
<a name="l00725"></a>00725             <span class="comment">//cout &lt;&lt; &quot;Seqnum now:&quot; &lt;&lt; _next_send_seq &lt;&lt; &quot; and &quot; &lt;&lt; _next_receive_seq &lt;&lt; endl;</span>
<a name="l00726"></a>00726          }
<a name="l00727"></a>00727       }
<a name="l00728"></a>00728    }
<a name="l00729"></a>00729    <span class="keywordflow">catch</span> (<a class="code" href="classFIX8_1_1f8Exception.html" title="Base exception class.">f8Exception</a>&amp; e)
<a name="l00730"></a>00730    {
<a name="l00731"></a>00731       <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(e.<a class="code" href="classFIX8_1_1f8Exception.html#abb6a7867b11df20e941a87b1c8447bb1">what</a>());
<a name="l00732"></a>00732    }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00735"></a>00735 }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00738"></a>00738 <span class="keywordtype">bool</span> <a class="code" href="classFIX8_1_1Session.html#a5821c2539f58e91fc4b2724a1d04eb5f">Session::handle_application</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> seqnum, <span class="keyword">const</span> <a class="code" href="classFIX8_1_1Message.html" title="A complete Fix message with header, body and trailer.">Message</a> *msg)
<a name="l00739"></a>00739 {
<a name="l00740"></a>00740    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00741"></a>00741 }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743 <span class="comment">//-------------------------------------------------------------------------------------------------</span>
<a name="l00744"></a><a class="code" href="classFIX8_1_1Session.html#a6b44f0258866134e9da79723c50dafa4">00744</a> <span class="keywordtype">void</span> <a class="code" href="classFIX8_1_1Session.html#a6b44f0258866134e9da79723c50dafa4" title="Recover next expected and next to send sequence numbers from persitence layer.">Session::recover_seqnums</a>()
<a name="l00745"></a>00745 {
<a name="l00746"></a>00746    <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acb236bba1eca3b8c6a636b74425aa574">_persist</a>)
<a name="l00747"></a>00747    {
<a name="l00748"></a>00748       <span class="keywordtype">unsigned</span> send_seqnum, receive_seqnum;
<a name="l00749"></a>00749       <span class="keywordflow">if</span> (<a class="code" href="classFIX8_1_1Session.html#acb236bba1eca3b8c6a636b74425aa574">_persist</a>-&gt;<a class="code" href="classFIX8_1_1Persister.html#a3e2bdbad7444ae43e26a3fb82bcaf613">get</a>(send_seqnum, receive_seqnum))
<a name="l00750"></a>00750       {
<a name="l00751"></a>00751          ostringstream ostr;
<a name="l00752"></a>00752          ostr &lt;&lt; <span class="stringliteral">&quot;Last sent: &quot;</span> &lt;&lt; send_seqnum &lt;&lt; <span class="stringliteral">&quot;, last received: &quot;</span> &lt;&lt; receive_seqnum;
<a name="l00753"></a>00753          <a class="code" href="classFIX8_1_1Session.html#ae3f51cc05cc9aa0e2d9aca7bcc7747aa">log</a>(ostr.str());
<a name="l00754"></a>00754          <a class="code" href="classFIX8_1_1Session.html#ad6f2667a215f076904429f16b4956434">_next_send_seq</a> = send_seqnum ;<span class="comment">// + 1;</span>
<a name="l00755"></a>00755          <a class="code" href="classFIX8_1_1Session.html#a5cb5ee26b47ae83c5e31071beb92eb2d">_next_receive_seq</a> = receive_seqnum ;<span class="comment">// + 1;</span>
<a name="l00756"></a>00756       }
<a name="l00757"></a>00757    }
<a name="l00758"></a>00758 }
<a name="l00759"></a>00759 
</pre></div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="session_8cpp.html">session.cpp</a>      </li>

    <li class="footer"><a href=http://www.fix8.org><b>Fix8</b></a> documentation generated on Tue Apr 24 2012 11:10:05. Copyright &copy; 2010-12, <a href=mailto:fix@fix8.org><b>David L. Dight.</b></a> All rights reserved.</li>
   </ul>
 </div>


</body>
</html>
